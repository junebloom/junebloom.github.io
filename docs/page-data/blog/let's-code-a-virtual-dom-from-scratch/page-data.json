{"componentChunkName":"component---src-templates-blog-post-template-js","path":"/blog/let's-code-a-virtual-dom-from-scratch/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Let's Code a Virtual DOM from Scratch","date":"2020-12-05"},"timeToRead":14,"html":"<p>Perhaps you're aware that React uses a \"virtual DOM\" (VDOM), and have wondered <em>\"What does that actually mean?\"</em>. There are perfectly concise answers to this question, but they're just, kind of uh, less-than-satisfying. Today we're going to answer this question a bit more deeply by coding a virtual DOM from scratch, so buckle up!</p>\n<p>There aren't a lot of situations where writing your own VDOM really makes sense, but it <em>is</em> a pretty fun, and you will learn a lot about how React and similar libraries work. Oh and as a bonus, we'll use our virtual DOM to make a todo app at the end.</p>\n<p>Let's get started!</p>\n<h2>Refresher: What is the DOM?</h2>\n<p><em>(Feel free to skip this section if you don't need the background.)</em></p>\n<p>DOM stands for <em>Document Object Model</em>. It is the standardized internal representation (<em>model</em>) that all browsers use for XML/HTML <em>documents</em>. Essentially, when a page loads, your browser parses the HTML source for the page and builds the DOM from it. An <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Element\">Element</a> or other <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Node\">Node</a> <em>object</em> is created from every tag, comment, piece of text content, etc. in the source.</p>\n<p>Take this HTML snippet for example:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span>Hello!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The browser will parse this HTML into two DOM objects:</p>\n<ul>\n<li>An <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/HTMLParagraphElement\">HTMLParagraphElement</a> to represent the <code class=\"language-text\">&lt;p&gt;&lt;/p&gt;</code> tag,</li>\n<li>and a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Text\">Text</a> Node to represent the <code class=\"language-text\">Hello!</code>.</li>\n</ul>\n<p>Once the DOM is built, the browser uses it to actually render the page and handle user interaction, but the most relevant part is that the browser exposes these DOM objects to us to manipulate via JavaScript. We can create, modify, and delete parts of the DOM from our JS code, an incredible power! We can make incredible dynamic content, games, whole applications! But there's a problem.</p>\n<h3>Declarative <em>vs</em> Imperative</h3>\n<p>The DOM manipulation APIs exposed to JS are <em>imperative</em>, while defining the DOM with HTML is <em>declarative</em>. If you aren't familiar with these two styles of programming, the difference can be illustrated like so:</p>\n<h4>Declarative:</h4>\n<blockquote>\n<p>I would like a peanut butter and banana sandwich, please!</p>\n</blockquote>\n<h4>Imperative:</h4>\n<blockquote>\n<p>Get a plate. Get a knife. Get two slices of bread. Put the bread on the plate. Slice the banana into 16 pieces with the knife. Spread one ounce of peanut butter on each slice of bread. Place 8 banana slices on each slice of bread. Place the two slices of bread together. Give me the plate.</p>\n</blockquote>\n<p>Basically, declarative code states the desired result and depends on some underlying code to be smart enough to figure out how to deliver it, whereas imperative code states a series of commands to follow to produce the desired result.</p>\n<p>Take a look at a real example, where we accomplish the same thing using both paradigms:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!--\nThis HTML code is declarative. The browser knows how to interpret and deliver\nthe desired result.\n--></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>Juniper<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">></span></span>Software Engineer<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// This JS code is imperative.</span>\n<span class=\"token comment\">// We're giving explicit instructions for the browser to follow to produce</span>\n<span class=\"token comment\">// the desired result.</span>\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> title <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> subtitle <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ntitle<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">\"Juniper\"</span><span class=\"token punctuation\">;</span>\nsubtitle<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">\"Software Engineer\"</span><span class=\"token punctuation\">;</span>\n\ncontainer<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncontainer<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>subtitle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Imperative programming is very necessary and important, but in the case of defining DOM structures, the declarative approach is a subjectively nicer developer experience.</p>\n<p>The role of a virtual DOM is to allow us to write complex user interfaces with all of the dynamic power of JavaScript, <em>declaratively</em>. So how does it work?</p>\n<h2>The Anatomy of a Virtual DOM</h2>\n<p>There are two main parts of a VDOM implementation.</p>\n<ul>\n<li>There is the <strong>VDOM tree</strong> itself, which is just a representation of the elements that make up the document tree,</li>\n<li>and there is a <strong>reconciliation algorithm</strong>, which takes the VDOM tree and turns it into actual DOM nodes that the browser understands.</li>\n</ul>\n<p>Constructing a VDOM tree should be <em>fast</em>. The idea is that we can just re-compute the entire VDOM every time something on the page changes, and then our reconciliation algorithm will figure out an efficient way to update the actual DOM to match.</p>\n<h2>The Virtual DOM Tree</h2>\n<p>We need to be able to represent HTML elements in a way that is fast to recompute. For this, let's define a very simple structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// A text node.</span>\n<span class=\"token comment\">// This is just some text that can be displayed on the page.</span>\n<span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> <span class=\"token string\">\"Hello, VDOM!\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// A single VDOM element.</span>\n<span class=\"token comment\">// This is an array where the first item is the tag name,</span>\n<span class=\"token comment\">// the second item is a dictionary of attributes (props),</span>\n<span class=\"token comment\">// and the third item is an array of child elements/text nodes.</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">\"https://...\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>text<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Using these humble building blocks, we can declaratively model any document tree we desire:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Home\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Welcome to my page!\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"I hope you enjoy it here.\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"footer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Made with &lt;3\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This kind of representation is very similar to what React uses, except React uses objects instead of arrays, and provides a <code class=\"language-text\">createElement</code> function to generate those objects, and most people use JSX, which hides the <code class=\"language-text\">createElement</code> calls behind a compile step, allowing you to write VDOM structures using XML-like syntax similar to HTML. But other than that, just like React!</p>\n<p><em>(If we wanted, we could write a simple function for the JSX compiler to compile to, allowing us to use JSX to create our VDOM structures, but I'll leave that as an exercise for you.)</em></p>\n<p>Now that we have defined what our VDOM structure should look like, we can write reusable functions to compose these structures:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// A generic \"page\" component to wrap our content with a header and footer</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Page</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">children</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"header\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Home\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">\"/about\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"About\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"footer\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Made with &lt;3\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// A home page</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">HomePage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Welcome to my page!\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"I hope you enjoy it here.\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// An about page</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">AboutPage</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"About Me\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"p\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"I like my DOMs virtual!\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Starting to look familiar? Reminds you a little bit of React's functional components, doesn't it?</p>\n<h2>The Algorithm</h2>\n<p>Tree structure defined, we just need an algorithm that can take our VDOM tree and update the actual DOM to reflect its content. This algorithm is of course the cold, imperative, robot heart of our virtual DOM. It makes our declarative code do something instead of nothing; a desirable feature.</p>\n<p>Our reconciliation algorithm will work by finding the difference (diff) between two VDOM trees. One tree represents the previous state of the document, and the other tree represents the new state of the document. The algorithm will use this diff to determine which DOM nodes to modify, and which ones to leave as they are.</p>\n<h3>Starting Small</h3>\n<p>Before we tackle diffing an entire tree, it would be useful to get our diffing-feet wet with an easier subproblem.</p>\n<p>We will need to know what properties of a single VDOM node have changed from one update to the next, so that we can atomically update just those properties if possible, rather than throwing out the whole real-DOM node and rebuilding it when a value changes.</p>\n<p>Let's write a simple <code class=\"language-text\">diffProps</code> function to identify those changes.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Shallowly compare the props of VDOM nodes `a` and `b`,</span>\n<span class=\"token comment\">// returning a map of changes, or null if there were no changes.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">diffProps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldProps <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> newProps <span class=\"token operator\">=</span> b<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> diff <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> changed <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Iterate over the props of each element and compare them, starting with a.</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> prop <span class=\"token keyword\">in</span> oldProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This will catch any props that were updated or removed between a and b.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> newProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      diff<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      changed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Now iterate over b's props.</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> prop <span class=\"token keyword\">in</span> newProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// This catches any new props of b that weren't present on a.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      diff<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      changed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> changed <span class=\"token operator\">?</span> diff <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>(This function could possibly be optimized by tracking which property names we checked in the first for loop, and skipping the comparison in the second for loop if we've already checked that property, but simple comparison is generally pretty fast so I'm not sure how much performance gain you'd see. Feel free to test it out!)</em></p>\n<p>You may have noticed that we only compare props one layer deep. This is for simplicity and performance reasons. It has the consequence that if we have a mutable prop, mutations won't be detected by our algorithm. So let's deal with that by saying that props must be treated as immutable. It's a feature!</p>\n<h3>Creating Real DOM Nodes</h3>\n<p>We need a function that can turn a VDOM node into something we can attach to the real DOM. This one's easy.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Create and return a real DOM node for the given VDOM node, recursively</span>\n<span class=\"token comment\">// creating any children as well.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createDomNode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Strings (text nodes) can be added directly to the DOM,</span>\n  <span class=\"token comment\">// so we don't need to do anything.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> node <span class=\"token operator\">===</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Create a new DOM element.</span>\n  <span class=\"token keyword\">const</span> tag <span class=\"token operator\">=</span> node<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> domNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Iterate over the props of the virtual node and set them as attributes.</span>\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> node<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> prop <span class=\"token keyword\">in</span> props<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domNode<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Create the node's children.</span>\n  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> node<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    domNode<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token function\">createDomNode</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Return the constructed DOM node.</span>\n  <span class=\"token keyword\">return</span> domNode<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function just creates the DOM node. Actually attaching it to the DOM will be done by the diffing algorithm, which we're ready to approach now!</p>\n<h3>Dealing with Diffing</h3>\n<p>This will be the final function for our VDOM implementation. It's job will be to recursively determine the diff between two VDOM trees and update the real DOM accordingly. Unlike <code class=\"language-text\">diffProps()</code>, this function will directly perform DOM modifications while it does the diff, rather than returning a diff object.</p>\n<p>The algorithm is pretty simple, but it can still be somewhat difficult to reason about, so I've done my best to make the code super digestible. I'll also give you a little background before we get to the code.</p>\n<p>First, here is the function signature:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is a recursive function, and it is important to recognize that, conceptually, we're really only dealing with one node per iteration: The so-called \"current node\".</p>\n<ul>\n<li><code class=\"language-text\">a</code> is the current node in its <em>previous state</em>, as a VDOM object.</li>\n<li><code class=\"language-text\">b</code> is the current node in its <em>new state</em>, as a VDOM object. This is the \"true\" current node to which the real DOM should conform.</li>\n<li>And <code class=\"language-text\">domParent.childNodes[index]</code> is the real-DOM object which corresponds to the current node's previous state, and which we wish to update to match <code class=\"language-text\">b</code>.</li>\n</ul>\n<p>It is also important to note that as nodes are added and removed, <code class=\"language-text\">b</code> is likely to be \"out of sync\" with <code class=\"language-text\">a</code> and <code class=\"language-text\">index</code>, possibly referencing a completely different node.</p>\n<p>I find it most helpful to remember that <code class=\"language-text\">b</code> is the current node's true state, while <code class=\"language-text\">a</code> and the DOM node referenced by <code class=\"language-text\">index</code> refer to what <em>used</em> to be where <code class=\"language-text\">b</code> currently is in the tree, regardless of whether that's the current node the same state, in an older state, or a completely different node. The job of the algorithm is to modify the DOM to match <code class=\"language-text\">b</code>, no matter how out of sync they may have gotten.</p>\n<p>Let's code!</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Recursively update the contents of DOM node `domParent` according to the</span>\n<span class=\"token comment\">// diff between the previous VDOM node `a` and the new VDOM node `b`.</span>\n<span class=\"token comment\">// `index` is the position of `a` as a real-DOM node in the</span>\n<span class=\"token comment\">// `domParent.childNodes` array.</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> isTextNode <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> b <span class=\"token operator\">===</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Is this a text node?</span>\n  <span class=\"token keyword\">let</span> typeChanged <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Did its type change? (div, p, li, etc.)</span>\n  <span class=\"token keyword\">let</span> updatedProps <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Which if any props changed?</span>\n\n  <span class=\"token comment\">// typeChanged and updatedProps are only needed for non-text nodes that</span>\n  <span class=\"token comment\">// previously existed and still exist.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isTextNode <span class=\"token operator\">&amp;&amp;</span> a <span class=\"token operator\">&amp;&amp;</span> b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    typeChanged <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> b<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>typeChanged<span class=\"token punctuation\">)</span> updatedProps <span class=\"token operator\">=</span> <span class=\"token function\">diffProps</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Determine if and how this node was modified.</span>\n  <span class=\"token keyword\">let</span> modification <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// If there is no previous-state, then the current node is newly added.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>a<span class=\"token punctuation\">)</span> modification <span class=\"token operator\">=</span> <span class=\"token string\">\"added\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// If there is no new-state, then the node was removed.</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>b<span class=\"token punctuation\">)</span> modification <span class=\"token operator\">=</span> <span class=\"token string\">\"removed\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// If the node is an element and its type changed (div, p, li, etc.), or</span>\n  <span class=\"token comment\">// if it is a text node and its text changed, then the node was replaced.</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>typeChanged <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>isTextNode <span class=\"token operator\">&amp;&amp;</span> a <span class=\"token operator\">!==</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> modification <span class=\"token operator\">=</span> <span class=\"token string\">\"replaced\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// If the node's type is the same but its properties changed,</span>\n  <span class=\"token comment\">// then the node was updated.</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>typeChanged <span class=\"token operator\">&amp;&amp;</span> updatedProps<span class=\"token punctuation\">)</span> modification <span class=\"token operator\">=</span> <span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Store a reference to the possibly existing DOM node, in case we need it.</span>\n  <span class=\"token keyword\">const</span> domNode <span class=\"token operator\">=</span> domParent<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Update the DOM.</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>modification<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"added\"</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Add the node to the DOM. (There is no existing DOM node.)</span>\n      domParent<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token function\">createDomNode</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"removed\"</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Remove the node from the DOM.</span>\n      domNode<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"replaced\"</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Replace the existing DOM node with a new one.</span>\n      domNode<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">createDomNode</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\"updated\"</span><span class=\"token operator\">:</span>\n      <span class=\"token comment\">// Update the node's props in-place, without re-creating the DOM node.</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> prop <span class=\"token keyword\">in</span> updatedProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        domNode<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> updatedProps<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Recurse.</span>\n  <span class=\"token comment\">// If the node wasn't added, removed, or replaced, then we need to recurse</span>\n  <span class=\"token comment\">// and update any children it may have.</span>\n  <span class=\"token comment\">// (If it was added or replaced, then updated children were already created</span>\n  <span class=\"token comment\">// by createDomNode, and removed nodes obviously don't need fresh children.)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>modification <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> modification <span class=\"token operator\">===</span> <span class=\"token string\">\"updated\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> oldChildren <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> newChildren <span class=\"token operator\">=</span> b<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>oldChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> newChildren<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span>oldChildren<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> newChildren<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> domNode<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we have everything we need for a functioning virtual DOM! Conceptually, this is similar to the <a href=\"https://reactjs.org/docs/reconciliation.html\">approach that React uses</a> for diffing, but in reality React is perhaps <em>slightly</em> <a href=\"https://github.com/acdlite/react-fiber-architecture\">more sophisticated</a> than what we've created.</p>\n<p>We could of course always add features and optimizations. Notably, we don't support string keys, which would allow us to avoid unnecessarily re-rendering a bunch of nodes when adding, moving, and removing a node in a list of siblings.</p>\n<p>But I don't want to do that. Instead, let's to put our little VDOM to the test.</p>\n<h2>Bonus: Todo or Not Todo</h2>\n<p>Let's do the \"Hello, World!\" of frontend engineering: the familiar todo app. Since we've only written a VDOM, we don't have any of the fancy fluff like state or update handling that a \"real\" frontend library or framework might provide, so we'll have to get our hands dirty and do some more DIY.</p>\n<p>But first we need to define the components for our app. For brevity, I'm omitting any styles, but a simple <code class=\"language-text\">classname</code> or <code class=\"language-text\">style</code> property is all it takes to unlock the full power of CSS styling in our little VDOM.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// First, a todo item component.</span>\n<span class=\"token comment\">// Clicking it marks it as complete.</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TodoItem</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> todo<span class=\"token punctuation\">,</span> completeTodo <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">\"li\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token function-variable function\">onclick</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">completeTodo</span><span class=\"token punctuation\">(</span>todo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">[</span>todo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Next, an input component for adding new todos.</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TodoInput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> input<span class=\"token punctuation\">,</span> setInput<span class=\"token punctuation\">,</span> addTodo <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Handles user typing into the text field.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">oninput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setInput</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Handles submitting the input.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onsubmit</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addTodo</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"form\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> onsubmit <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"input\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> input<span class=\"token punctuation\">,</span> oninput <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"button\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">\"submit\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Add todo\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// And most importantly, a todo app component to put it all together.</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TodoApp</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> setState</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Updates the text input state.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setInput</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> input<span class=\"token operator\">:</span> value <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Adds a new todo item.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">addTodo</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">todo</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span> todos<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>state<span class=\"token punctuation\">.</span>todos<span class=\"token punctuation\">,</span> todo<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Marks a todo item as complete.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">completeTodo</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">todo</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n      todos<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>todos<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> item <span class=\"token operator\">!==</span> todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"main\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Todo\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">TodoInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> input<span class=\"token operator\">:</span> state<span class=\"token punctuation\">.</span>input<span class=\"token punctuation\">,</span> setInput<span class=\"token punctuation\">,</span> addTodo <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">\"ul\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">.</span>todos<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">todo</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">TodoItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> todo<span class=\"token punctuation\">,</span> completeTodo <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now we need to whip up some \"improvised frontend library\" glue to bring our VDOM to life. <em>(Don't expect anything too amazing! This article is about implementing a VDOM, not a whole UI library.)</em></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Set up the app internals for mounting to the DOM and handling updates.</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This is the DOM element to mount the VDOM to.</span>\n  root<span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// This is a functional component that returns the VDOM tree for our app.</span>\n  component<span class=\"token operator\">:</span> TodoApp<span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// For state, we'll just use an object.</span>\n  state<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    todos<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    input<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">// Store our VDOM so we can diff it when we perform updates.</span>\n  vdom<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Renders the app's VDOM and updates the real DOM to match.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Compute the VDOM.</span>\n  <span class=\"token keyword\">const</span> old <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span>vdom<span class=\"token punctuation\">;</span>\n  app<span class=\"token punctuation\">.</span>vdom <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">component</span><span class=\"token punctuation\">(</span>getState<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Update the real DOM.</span>\n  <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span>old<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">.</span>vdom<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Updates the state and triggers a render.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  app<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Perform the initial render.</span>\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And in just a few easy steps, we have a fully functional todo app built with our very own virtual DOM. Check it out! Click a todo item to complete it. Add your own todos. Everything works.</p>\n<iframe height=\"340\" style=\"width: 100%;\" scrolling=\"no\" title=\"VDOM from Scratch: Todo\" src=\"https://codepen.io/junebloom/embed/OJRPLeY?height=340&theme-id=dark&default-tab=result\" frameborder=\"no\" loading=\"lazy\" allowtransparency=\"true\" allowfullscreen=\"true\">\n  See the Pen <a href='https://codepen.io/junebloom/pen/OJRPLeY'>VDOM from Scratch: Todo</a> by Juniper\n  (<a href='https://codepen.io/junebloom'>@junebloom</a>) on <a href='https://codepen.io'>CodePen</a>.\n</iframe>\n<h2>Conclusion</h2>\n<p>By this point we have explored why a virtual DOM can be useful, how to design the actual structure of a VDOM, how to reconcile that structure with the real DOM, and how these things relate to React.</p>\n<p>As engineers, understanding how our tools work is important. If we have deep knowledge of our tools, then we can use them in creative ways, we can avoid misusing them, we can hack them, we can build new ones, and we can simply better appreciate the hard work that goes in to making the things we may take for granted.</p>\n<p>I hope you learned something new or at least had fun! </p>\n<p><em>(You can find the source for the implementations in this article <a href=\"https://github.com/junebloom/junebloom.github.io/tree/main/examples/vdom\">here</a>.)</em></p>\n<h3>Further Reading</h3>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction\">Introduction to the DOM</a> @ MDN</li>\n<li><a href=\"https://reactjs.org/docs/faq-internals.html\">React's take on virtual DOM</a> @ React Docs</li>\n<li><a href=\"https://reactjs.org/docs/reconciliation.html\">Reconciliation in React</a> @ React Docs</li>\n<li><a href=\"https://github.com/acdlite/react-fiber-architecture\">React Fiber Architecture</a> @ Andrew Clark</li>\n</ul>"}},"pageContext":{"slug":"/blog/let's-code-a-virtual-dom-from-scratch/"}},"staticQueryHashes":["3159585216","63159454"]}